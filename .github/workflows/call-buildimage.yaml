name: CI Workflow

on:
  workflow_dispatch:
    branch:
      - feature-MOVE-3649-oppgradere-service-registry-pipeline
  push:
    branches:
      - '*'
  pull_request:
    types: [ ]  # Empty list ensures PRs are not triggered. Trigger nytt bygg........

jobs:

  build-install-and-deploy-libs:
    uses: felleslosninger/github-workflows/.github/workflows/ci-maven-install-deploy-lib.yml@efm-tilpasninger-2
    with:
      java-version: 11
      sbom-path: serviceregistry-server/target/
    secrets: inherit

  call-workflow-image-build-publish:
    uses: felleslosninger/github-workflows/.github/workflows/ci-spring-boot-build-publish-image.yml@efm-tilpasninger-2
    needs: [ build-install-and-deploy-libs ]
    with:
      multi-module-project-path: serviceregistry-server/
      module-to-build: serviceregistry-server
      java-version: 11
    secrets: inherit

  call-update-image-version:
    needs: [ call-workflow-image-build-publish ]
    uses: felleslosninger/github-workflows/.github/workflows/ci-update-image-version.yml@efm-tilpasninger-2
    with:
      kubernetes-repo: eformidling-cd
      image-version: ${{ needs.call-workflow-image-build-publish.outputs.image-version }}
      image-digest: ${{ needs.call-workflow-image-build-publish.outputs.image-digest }}
    secrets: inherit